<?php
$mal_kontaktadresse="rune.sydskjor@uninett.no"; // obligatorisk
$mal_overskrift="Karantene"; // obligatorisk
$mal_tegnsett="utf-8";
include "uninetttopp.php3";
?>
<dl>
  <dt>REVISJON:</dt>
  <dd>DES-2010<dd>
  <dt>ANSVARLIG:</dt>
  <dd>Rune Sydskjør</dd>
  <dt>DATO:</dt>
  <dd>02.12.2010</dd>
</dl>

<hr>

<h2>Innledning</h2>
<p>
I sin enkleste form er det kun ruterne og en server med squid/squidguard som trengs for å realisere en
karantenenettsløsning. Ruteren vil sende all web-trafikk (port 80) til serveren som omskriver brukerens opprinnelig web-forespørsel og presenterer en annen webside med informasjon om karantenenettet og om
hvorfor brukeren har havnet der.
I tillegg trenger man også komponenter som setter en aktuell svitsjeport i et karantenenett/VLAN. Arnold i NAV kan for eksempel brukes for dette.
I tillleg kan man der man har tatt ibruk 802.1x bruke "fallback-VLAN/unauth-VLAN" på switchene som sørger for å sette en bruker i karantene-vlan'et dersom han ikke klarer å logge seg inn.
</p>

<h2>Oppsett på ruter</h2>
<p>
<h3>Skru på globalt</h3>
<code>ip wccp web-cache redirect-list 108 group-list 8</code>
Vha. denne kommandoen skrur man på WCCP globalt på ruteren. I tillegg setter vi en redirect-list som
definerer hva som IKKE skal WCCP'es og en group-list som definerer hvilke Squid-servere som har lov til å
opprette GRE-tunnel mot denne ruteren. Disse access-listene kan f.eks se slik ut:
<code>
<pre>
access-list 8 permit 129.241.23.234
access-list 8 deny
any
access-list 108 remark ** Ting som skal unnslippe WCCP
access-list 108 deny ip any host 129.241.18.32
access-list 108 permit ip any any
</pre>
</code>

<h3>Skru på for ett vlan</h3>
<code>
<pre>
interface Vlan333
ip access-group vlan333in in
ip access-group vlan333out out
ip wccp web-cache redirect in
</pre>
</code>
Her setter vi at all web-trafikk (port 80) inn på VLANet skal redirigeres. På VLANene har vi i tillegg definert
èn inngående og èn utgående access-liste. Dette for at i enkelte karantenenett skal det være mulig å gjøre
enkelte ting (f.eks lese og sende mail). Slike åpninger defineres da i disse access-listene.
</p>

<h2>Oppsett på verktøykasse</h2>

Alle verktøykasser er satt opp default til ikke å starte squid. For at verktøykassen skal kjøre squid er du nødt til å legge til ei tom fil i cfengine /etc/default/squid. (Fra før finnes det ei fil der som sier exit)

<h3>/etc/network/interfaces</h3>
<p>
Denne fila vedlikeholdes via svn, og endringer må gjøres der.
For at GRE-tunnelen (mellom ruter og server) skal fungere opp mot de forskjellige ruterene, så må det legges
inn ett tunnel-interface for hver ruter som ser slik ut:
<code>
<pre>
auto <tunnellnavn>
    iface <tunnellnavn> inet static
    address <adresse for vk>
    netmask 255.255.255.255
    mtu 1476
    pre-up iptunnel add <tunnellnavn> mode gre local <adresse for vk> remote <loopback for ruter>
    post-down iptunnel del <tunnellnavn>
</pre>
</code>

Her er ett ekspempel ved hiof:
<code>
<pre>
auto tun-c6500-h-1
    iface tun-c6500-h-1 inet static
    address 158.39.160.109
    netmask 255.255.255.255
    mtu 1476
    pre-up iptunnel add tun-c6500-h-1 mode gre local 158.39.160.109 remote 128.39.0.92
    post-down iptunnel del tun-c6500-h-1
</pre>
</code>
Her er adressen på tunnel-interfacet lik IP-adressen til serveren, men med maske 255.255.255.255. MTU
settes til 1476 for å slippe fragmentering av GRE-pakkene.
HUSK: Ett slikt interface for HVER ruter som serveren skal kunne snakke med.
</p>

<h3>/etc/squid3/squid.conf</h3>
<p>
Slik ser hele squid.conf ut:
<code>
</pre>
acl manager proto cache_object
acl localhost src 127.0.0.1/32
acl to_localhost dst 127.0.0.0/8

# Kan strupes inn for kun å gjelde karantene-nettet
acl karantenenett src 0.0.0.0/0

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025
acl Safe_ports port 65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl CONNECT method CONNECT

http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny to_localhost

http_access allow localhost
http_access allow karantenenett

# wccp2_router skal staa til default gw for squid server, eller til nærmeste link-adresse (loopback fungerer ikke)
wccp2_router 158.39.160.1
wccp2_router 128.39.46.74
# Dersom verktøykassen står tilkoblet ruteren den skal snakke wccp med, kan dette gjøres på lag 2 med disse kommandoene. Disse må være utkommentert dersom institusjonen har flere studiesteder, og skal bruke denne løsningen mot samme verktøykasse. (Trafikk må da gå på lag 3)
#wccp2_forwarding_method 2
#wccp2_return_method 2
#wccp2_assignment_method 2

http_access deny all

icp_access deny all

htcp_access deny all

http_port 3128 transparent

hierarchy_stoplist cgi-bin ?

logformat squid %tl %6tr %>a %Ss/%03Hs %<st %rm %ru %un %Sh/%<A %mt

access_log /var/log/squid3/access.log squid

url_rewrite_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf

url_rewrite_children 10

cache deny all

refresh_pattern ^ftp:	1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern .	0	20%	4320

icp_port 3130

coredump_dir /var/spool/squid3
</pre>
</code>
</p>

<h3>/etc/squid/squidGuard.conf</h3>
<p>
Slik ser squidGuard.conf ut:
<code>
<pre>
logdir /var/log/squid3

# Her er det kun definert èn klasse
# Du kan lage flere klasser og filtrere på avsenderadresse. Da kan du redirigere til forskjellige sider
src abuse {
        ip 0.0.0.0/0
}

dest aapne {
	# Sier hvilke url/domener som ikke skal redirigeres.
        # Disse ligger under /var/lib/squidguard/db/
        urllist aapne_url
        domainlist aapne_domain
}

# Husk at du her må redirigere til ei webside som ligger i aapne_domain eller aapne_url
acl {
        abuse {
                pass aapne none
                redirect 302:http://karantene.hix.no
        }

        default {
                pass aapne none
                redirect 302:http://karantene.hix.no
        }
}
</pre>
</code>
</p>

<h3>/var/lib/squidguard/db/aapne_url</h3>
<p>
<code>
<pre>
# List opp hvilke URL'er som skal slippe igjennom uten redirect
www.hix.no/kontakt_it_avdeling.html
</pre>
</code>
</p>

<h3>/var/lib/squidguard/db/aapne_domain</h3>
<p>
<code>
<pre>
# List opp hvilke domener som skal slippe igjennom uten redirect
hix.no
microsoftupdate.com
virusupdate.com
</pre>
</code>
</p>

<p>
<h3>/proc/sys/net/ipv4/ip_forward</h3>
Denne må stå til 1
</p>

<p>
<h3>IPtables</h3>
<code>iptables -t nat -A PREROUTING -i tun-c6500-k-1 -p tcp --dport 80 -j REDIRECT --to-ports 3128</code>
FIX: Denne legges inn under /etc/network/ifup/....
tun-c6500-k-1 refererer her til tunnellinterfacet i /etc/network/interfaces. Har man flere tuneller må man ha egne innslag for hver tunnell.
Dette sørger for at trafikk inn på tunnel-interfacet (fra ruteren) på TCP-port 80 blir REDIRECT'et til TCP-port 3128 hvor squid lytter.
</p>

<h2>Kontaktpersoner</h2>
<ul>
  <li>rune.sydskjor@uninett.no</li>
</ul>

<?php
include "uninettbunn.php3";
?>
