"use strict";(self.webpackChunkdocs_sikt_no=self.webpackChunkdocs_sikt_no||[]).push([[5977],{3905:(e,t,n)=>{n.d(t,{Zo:()=>k,kt:()=>g});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},k=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,k=l(e,["components","mdxType","originalType","parentName"]),d=p(n),g=r,u=d["".concat(s,".").concat(g)]||d[g]||m[g]||i;return n?a.createElement(u,o(o({ref:t},k),{},{components:n})):a.createElement(u,o({ref:t},k))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7020:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const i={title:"Maskinporten som token-tjeneste i Gravitee"},o="Maskinporten som token-tjeneste i Gravitee",l={unversionedId:"datadeling/teknisk-plattform/api/maskinporten",id:"datadeling/teknisk-plattform/api/maskinporten",title:"Maskinporten som token-tjeneste i Gravitee",description:"Flere virksomheter krever at du autentiserer deg med Maskinporten f\xf8r du kan",source:"@site/docs/datadeling/teknisk-plattform/api/maskinporten.md",sourceDirName:"datadeling/teknisk-plattform/api",slug:"/datadeling/teknisk-plattform/api/maskinporten",permalink:"/docs/datadeling/teknisk-plattform/api/maskinporten",draft:!1,editUrl:"https://github.com/sikt-no/docs/tree/master/docs/datadeling/teknisk-plattform/api/maskinporten.md",tags:[],version:"current",lastUpdatedAt:1688112669,formattedLastUpdatedAt:"Jun 30, 2023",frontMatter:{title:"Maskinporten som token-tjeneste i Gravitee"},sidebar:"datadeling",previous:{title:"Integra",permalink:"/docs/datadeling/teknisk-plattform/api/integra"},next:{title:"Selvbetjening for RabbitMQ",permalink:"/docs/datadeling/teknisk-plattform/brom"}},s={},p=[{value:"1 F\xe5 tilgang i Samarbeidsportalen",id:"1-f\xe5-tilgang-i-samarbeidsportalen",level:2},{value:"2 Generer n\xf8kler lokalt",id:"2-generer-n\xf8kler-lokalt",level:2},{value:"3 Sett opp i Samarbeidsportalen",id:"3-sett-opp-i-samarbeidsportalen",level:2},{value:"4 Konfigurasjons steg i Gravitee",id:"4-konfigurasjons-steg-i-gravitee",level:3},{value:"5 Alternative oppsett",id:"5-alternative-oppsett",level:2}],k={toc:p};function m(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},k,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"maskinporten-som-token-tjeneste-i-gravitee"},"Maskinporten som token-tjeneste i Gravitee"),(0,r.kt)("p",null,"Flere virksomheter krever at du autentiserer deg med Maskinporten f\xf8r du kan\nhente ut data fra deres API, for eksempel DF\xd8. I dette dokumentet f\xe5r du en\nbeskrivelse p\xe5 hvordan du setter opp en token-tjeneste i API Manager for\nMaskinporten, slik at du kan bruke dette for API som krever det."),(0,r.kt)("p",null,"For mer informasjon og forklaring av oppsett, se ",(0,r.kt)("a",{parentName:"p",href:"/docs/datadeling/veiledere/api-manager/jwt-mot-backend"},"Backend-autentisering med\nJWTs"),"."),(0,r.kt)("p",null,"Oppskriften er den samme for produksjons og testmilj\xf8et til maskinporten. De\nstegene som er forskjellig har vi markert hva som gjelder for produksjon og\nhva som gjelder for test."),(0,r.kt)("h2",{id:"1-f\xe5-tilgang-i-samarbeidsportalen"},"1 F\xe5 tilgang i Samarbeidsportalen"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Opprett en bruker i ",(0,r.kt)("a",{parentName:"p",href:"https://selvbetjening-samarbeid-ver2.difi.no"},"Samarbeidsportalen til\nDigdir"),". Hvis du vil kan du n\xe5\nsette opp en integrasjon mot test-milj\xf8et til Maskinporten.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"F\xe5 delegert rollen ",(0,r.kt)("em",{parentName:"p"},"Selvbetjening av integrasjoner i\nID-porten/Maskinporten"),". Dette gj\xf8r at du kan sette opp integrasjoner for\nproduksjonsmilj\xf8et for Maskinporten, for din virksomhet. Dette m\xe5 delegeres\nav hovedadministratoren til virksomheten - vanligvis universitetsdirekt\xf8r\neller h\xf8gskoledirekt\xf8r. Se siden ",(0,r.kt)("a",{parentName:"p",href:"https://docs.digdir.no/docs/Maskinporten/maskinporten_sjolvbetjening_web.html#tilgang-i-produksjonsmilj%C3%B8"},"Digdir: Tilgang i\nproduksjonsmilj\xf8"),"\nfor hvordan dette gj\xf8res."))),(0,r.kt)("p",null,"Hvis du ikke kan f\xe5 denne tilgangen m\xe5 noen andre som har tilgang utf\xf8re\npunktene nedenfor som gj\xf8res i Samarbeidsportalen."),(0,r.kt)("h2",{id:"2-generer-n\xf8kler-lokalt"},"2 Generer n\xf8kler lokalt"),(0,r.kt)("p",null,"Lag en egen n\xf8kkel for \xe5 bruke i Maskinporten:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Generer en n\xf8kkel med ssh:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ssh-keygen -t rsa -b 4096 -m PEM -f maskinporten-rs256.key\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Generer en offentlig n\xf8kkel i PEM-format, med OpenSSL:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ openssl rsa -in maskinporten-rs256.key -pubout -outform PEM -out maskinporten-rs256.key.pub.pem\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Konverter n\xf8kkelen til JWK-format (Java Web Key), siden det er dette\nMaskinporten krever. Dette kan gj\xf8res p\xe5 flere m\xe5ter, men vi foresl\xe5r\n",(0,r.kt)("a",{parentName:"li",href:"https://github.com/oyviaase/okta-jwks-to-pem.git"},"pem_to_jwks.py"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ git clone git@github.com:oyviaase/okta-jwks-to-pem.git\n$ cd okta-jwks-to-pem\n$ python3 pem_to_jwks.py --kid maskinporten-uio ../maskinporten.key.pub.pem\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Husk")," \xe5 notere parameteret du satt som ",(0,r.kt)("inlineCode",{parentName:"p"},"--kid"),". Du vil trenge dette n\xe5r du\nsetter opp Maskinporten-API-et i Gravitee senere."),(0,r.kt)("h2",{id:"3-sett-opp-i-samarbeidsportalen"},"3 Sett opp i Samarbeidsportalen"),(0,r.kt)("p",null,"Hvis du allerede har satt opp Maskinporten i Samarbeidsportalen som du \xf8nsker\ngjenbruke, kan du hoppe til steg 4:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Logg inn i Samarbeidsportalen og velg ",(0,r.kt)("em",{parentName:"p"},"INTEGRASJONER"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Trykk p\xe5 ",(0,r.kt)("em",{parentName:"p"},"+Ny integrasjon"),". Pass p\xe5 at det st\xe5r ",(0,r.kt)("em",{parentName:"p"},"PRODUKSJON")," eller ",(0,r.kt)("em",{parentName:"p"},"VER2"),"(for ",(0,r.kt)("strong",{parentName:"p"},"testmilj\xf8et")," til maskinporten) i\nknappen ved siden av:\n",(0,r.kt)("a",{target:"_blank",href:n(7066).Z},(0,r.kt)("img",{alt:"Administrer  integrasjoner",src:n(5080).Z,width:"3008",height:"2232"})))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Fyll ut skjemaet:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Difi-tjeneste"),": Maskinporten "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Scopes"),": De du trenger. Ta eventuelt kontakt med leverand\xf8rene av API-et for \xe5 vite hvilke scopes de krever."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Navn p\xe5 integrasjonen"),": V\xe5rt eksempel: ",(0,r.kt)("inlineCode",{parentName:"li"},"uio-gravitee-(prod|test)"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Tillatte grant types"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"urn:ietf:params:oauth:grant-type:jwt-bearer")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Klientautentiseringsmetode"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"private_key_jwt")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Applikasjonstype"),": web "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Authorization levetid (sekunder)"),": 0"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Access token levetid (sekunder)"),": 0"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Refresh token levetid (sekunder)"),": 0"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Refresh token type"),": Engangs")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{target:"_blank",href:n(4389).Z},(0,r.kt)("img",{alt:"Lag en ny  integrasjon",src:n(3265).Z,width:"3008",height:"3012"})))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Last opp JWT-n\xf8kkel\nVelg integrasjonen du nettopp laget og velg ",(0,r.kt)("em",{parentName:"p"},"Egne public n\xf8kler"),". I dialog-vinduet kopierer du inn output fra kommandoen i steg 3 i ",(0,r.kt)("a",{parentName:"p",href:"#Lokale-forberedelser"},"Lokale forberedelser"),", men med hakeparentes rundt innholdet. Et eksempel:"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[{"alg": "RS256", "e": "AQAB", "n": "XXXXXXXXXXXXXX...XXXXXXXXXXXXX", "kid": "uio-gravitee-test", "kty": "RSA", "use": "sig"}]\n')),(0,r.kt)("p",null,"   ",(0,r.kt)("a",{target:"_blank",href:n(9489).Z},(0,r.kt)("img",{alt:"Last opp n\xf8kkel",src:n(1973).Z,width:"3108",height:"5130"}))),(0,r.kt)("h3",{id:"4-konfigurasjons-steg-i-gravitee"},"4 Konfigurasjons steg i Gravitee"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{target:"_blank",href:n(2626).Z},"Last ned template for API-definisjonen for maskinporten.")," og last den opp i graviteee. Se ",(0,r.kt)("a",{parentName:"li",href:"/docs/datadeling/veiledere/api-manager/importer-api"},"veileder for \xe5 registrere en tjeneste i API manager via fil"),"."),(0,r.kt)("li",{parentName:"ol"},"Om dette er mot ",(0,r.kt)("strong",{parentName:"li"},"produksjonsystem")," i stedet for ",(0,r.kt)("strong",{parentName:"li"},"test"),", naviger til proxy og endpoint (under backend services) . Klikk p\xe5 tannhjulet for PROD, fjern haken for backup endpoint. Slett TEST eller huk av for at test skal v\xe6re backup endpint. ",(0,r.kt)("strong",{parentName:"li"},"Husk \xe5 lagre")),(0,r.kt)("li",{parentName:"ol"},'G\xe5 p\xe5 design. Klikk p\xe5 policy "Generate JWT" Fyll inn:',(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"_",(0,r.kt)("em",{parentName:"li"},"Key ID"),": det samme parameteren man satte som ",(0,r.kt)("inlineCode",{parentName:"li"},"--kid")," i steg 3 i ",(0,r.kt)("a",{parentName:"li",href:"#Lokale-forberedelser"},"Lokale forberedelser")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"audiences"),": Settes til",(0,r.kt)("inlineCode",{parentName:"li"},"https://maskinporten.no/"),"hvis det er ",(0,r.kt)("strong",{parentName:"li"},"produksjon")," eller ",(0,r.kt)("inlineCode",{parentName:"li"},"https://ver2.maskinporten.no")," hvis det er ",(0,r.kt)("strong",{parentName:"li"},"test")," milj\xf8et man skal bruke"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Private key")," Den private n\xf8kkelen laget i steg 1 i ",(0,r.kt)("a",{parentName:"li",href:"#Lokale-forberedelser"},"Lokale forberedelser")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Husk \xe5 lagre"),(0,r.kt)("a",{target:"_blank",href:n(1518).Z},(0,r.kt)("img",{alt:"Konfigurerer generateJWT",src:n(1973).Z,width:"3108",height:"5130"}))))),(0,r.kt)("li",{parentName:"ol"},"G\xe5 til Portal og details. Klikk p\xe5 ",(0,r.kt)("em",{parentName:"li"},"START THE API")," og ",(0,r.kt)("em",{parentName:"li"},"PUBLISH THE API"),". Vi anbefaler at du for dette APIet ikke klikker p\xe5 ",(0,r.kt)("em",{parentName:"li"},"MAKE PUBLIC"))),(0,r.kt)("h2",{id:"5-alternative-oppsett"},"5 Alternative oppsett"),(0,r.kt)("p",null,"Det som er beskrevet over er anbefalt m\xe5te \xe5 sette opp autentisering mot\nMaskinporten. Det finnes noen andre alternativ, men som vi ikke anbefaler:"),(0,r.kt)("p",null,"Den f\xf8rste er \xe5 bruke virksomhetssertifikatet direkte. Virksomhetssertifikatet\nlastes da opp i API manager, slik at det brukes av token-tjenesten. Dette\nanbefales ikke siden virksomhetssertifikatet generelt ikke b\xf8r deles utenfor\negen institusjon."),(0,r.kt)("p",null,"Det andre alternativet er \xe5 sette opp en mikrotjeneste som kj\xf8rer lokalt hos\ninstitusjonen, som h\xe5ndterer tokens n\xe5r API manager gj\xf8r API-kall mot\nMaskinporten. Dette er noe mer komplisert enn anbefalingen, siden det krever at\ndu setter opp og drifter en lokal tjeneste."))}m.isMDXComponent=!0},2626:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/files/maskinporten-api-template-b06a2a481d076f36c690b41b304e242d.json"},7066:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/files/Samarbeidsportalen-administrasjon-av-tjeneste-b71739839db1b431571506288a8d9436.png"},9489:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/files/Samarbeidsportalen-last-opp-nokkel-d93d3d864d457e67fa978eae276f60d0.png"},4389:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/files/Samarbeidsportalen-opprett-tjeneste-233eccc13dc49dad3be869ecd17a4841.png"},1518:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/files/gravitee-generate-jwt-maskinporten-aca6f1669da921f4e82543780a4db9b6.png"},5080:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Samarbeidsportalen-administrasjon-av-tjeneste-b71739839db1b431571506288a8d9436.png"},1973:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Samarbeidsportalen-last-opp-nokkel-d93d3d864d457e67fa978eae276f60d0.png"},3265:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Samarbeidsportalen-opprett-tjeneste-233eccc13dc49dad3be869ecd17a4841.png"}}]);