"use strict";(self.webpackChunkdocs_sikt_no=self.webpackChunkdocs_sikt_no||[]).push([[5977],{6563:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>k,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var r=t(5893),s=t(1151);const i={title:"Maskinporten som token-tjeneste i Gravitee"},a="Maskinporten som token-tjeneste i Gravitee",l={id:"datadeling/teknisk-plattform/api/maskinporten",title:"Maskinporten som token-tjeneste i Gravitee",description:"Flere virksomheter krever at du autentiserer deg med Maskinporten f\xf8r du kan",source:"@site/docs/datadeling/teknisk-plattform/api/maskinporten.md",sourceDirName:"datadeling/teknisk-plattform/api",slug:"/datadeling/teknisk-plattform/api/maskinporten",permalink:"/docs/datadeling/teknisk-plattform/api/maskinporten",draft:!1,unlisted:!1,editUrl:"https://github.com/sikt-no/docs/tree/master/docs/datadeling/teknisk-plattform/api/maskinporten.md",tags:[],version:"current",lastUpdatedAt:1704357550,formattedLastUpdatedAt:"Jan 4, 2024",frontMatter:{title:"Maskinporten som token-tjeneste i Gravitee"},sidebar:"datadeling",previous:{title:"Integra",permalink:"/docs/datadeling/teknisk-plattform/api/integra"},next:{title:'Rolf er et rolleregister, som blant annet brukes av UH-sak (sak og arkiv) for \xe5 forvalte personers forretningsroller, som brukes for UH-sak sin tilgangsstyring. "Rolf SA API" er Rolf sitt API som er det som brukes av UH-sak. Rolf driftes av UiO, se nettsidene [Rolf sektorverkt\xf8y for systematisk bruk av roller](https://www.uio.no/tjenester/it/adm-app/rolf) for mer informasjon',permalink:"/docs/datadeling/teknisk-plattform/api/rolf-api"}},o={},d=[{value:"1 F\xe5 tilgang i Samarbeidsportalen",id:"1-f\xe5-tilgang-i-samarbeidsportalen",level:2},{value:"2 Generer n\xf8kler lokalt",id:"2-generer-n\xf8kler-lokalt",level:2},{value:"3 Sett opp i Samarbeidsportalen",id:"3-sett-opp-i-samarbeidsportalen",level:2},{value:"4 Konfigurasjons steg i Gravitee",id:"4-konfigurasjons-steg-i-gravitee",level:3},{value:"5 Alternative oppsett",id:"5-alternative-oppsett",level:2}];function p(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"maskinporten-som-token-tjeneste-i-gravitee",children:"Maskinporten som token-tjeneste i Gravitee"}),"\n",(0,r.jsx)(n.p,{children:"Flere virksomheter krever at du autentiserer deg med Maskinporten f\xf8r du kan\nhente ut data fra deres API, for eksempel DF\xd8. I dette dokumentet f\xe5r du en\nbeskrivelse p\xe5 hvordan du setter opp en token-tjeneste i API Manager for\nMaskinporten, slik at du kan bruke dette for API som krever det."}),"\n",(0,r.jsxs)(n.p,{children:["For mer informasjon og forklaring av oppsett, se ",(0,r.jsx)(n.a,{href:"/docs/datadeling/veiledere/api-manager/jwt-mot-backend",children:"Backend-autentisering med\nJWTs"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Oppskriften er den samme for produksjons og testmilj\xf8et til maskinporten. De\nstegene som er forskjellig har vi markert hva som gjelder for produksjon og\nhva som gjelder for test."}),"\n",(0,r.jsxs)(n.p,{children:["Husk at n\xf8kler har varighet p\xe5 ",(0,r.jsx)(n.strong,{children:"ett \xe5r"})," og m\xe5 ",(0,r.jsx)(n.a,{href:"https://docs.digdir.no/docs/Maskinporten/maskinporten_feilsoking#invalid-assertion-client-authentication-failed-expired-key",children:"fornyes"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"1-f\xe5-tilgang-i-samarbeidsportalen",children:"1 F\xe5 tilgang i Samarbeidsportalen"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Opprett en bruker i ",(0,r.jsx)(n.a,{href:"https://selvbetjening-samarbeid-ver2.difi.no",children:"Samarbeidsportalen til\nDigdir"}),". Hvis du vil kan du n\xe5\nsette opp en integrasjon mot test-milj\xf8et til Maskinporten."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["F\xe5 delegert rollen ",(0,r.jsx)(n.em,{children:"Selvbetjening av integrasjoner i\nID-porten/Maskinporten"}),". Dette gj\xf8r at du kan sette opp integrasjoner for\nproduksjonsmilj\xf8et for Maskinporten, for din virksomhet. Dette m\xe5 delegeres\nav hovedadministratoren til virksomheten - vanligvis universitetsdirekt\xf8r\neller h\xf8gskoledirekt\xf8r. Se siden ",(0,r.jsx)(n.a,{href:"https://docs.digdir.no/docs/Maskinporten/maskinporten_sjolvbetjening_web.html#tilgang-i-produksjonsmilj%C3%B8",children:"Digdir: Tilgang i\nproduksjonsmilj\xf8"}),"\nfor hvordan dette gj\xf8res."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Hvis du ikke kan f\xe5 denne tilgangen m\xe5 noen andre som har tilgang utf\xf8re\npunktene nedenfor som gj\xf8res i Samarbeidsportalen."}),"\n",(0,r.jsx)(n.h2,{id:"2-generer-n\xf8kler-lokalt",children:"2 Generer n\xf8kler lokalt"}),"\n",(0,r.jsx)(n.p,{children:"Lag en egen n\xf8kkel for \xe5 bruke i Maskinporten:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Generer en n\xf8kkel med ssh:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ ssh-keygen -t rsa -b 4096 -m PEM -f maskinporten-rs256.key\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"Generer en offentlig n\xf8kkel i PEM-format, med OpenSSL:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ openssl rsa -in maskinporten-rs256.key -pubout -outform PEM -out maskinporten-rs256.key.pub.pem\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsxs)(n.li,{children:["Konverter n\xf8kkelen til JWK-format (Java Web Key), siden det er dette\nMaskinporten krever. Dette kan gj\xf8res p\xe5 flere m\xe5ter, men vi foresl\xe5r\n",(0,r.jsx)(n.a,{href:"https://github.com/oyviaase/okta-jwks-to-pem.git",children:"pem_to_jwks.py"}),":"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ git clone git@github.com:oyviaase/okta-jwks-to-pem.git\n$ cd okta-jwks-to-pem\n$ python3 pem_to_jwks.py --kid maskinporten-uio ../maskinporten.key.pub.pem\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Husk"})," \xe5 notere parameteret du satt som ",(0,r.jsx)(n.code,{children:"--kid"}),". Du vil trenge dette n\xe5r du\nsetter opp Maskinporten-API-et i Gravitee senere."]}),"\n",(0,r.jsx)(n.h2,{id:"3-sett-opp-i-samarbeidsportalen",children:"3 Sett opp i Samarbeidsportalen"}),"\n",(0,r.jsx)(n.p,{children:"Hvis du allerede har satt opp Maskinporten i Samarbeidsportalen som du \xf8nsker\ngjenbruke, kan du hoppe til steg 4:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Logg inn i Samarbeidsportalen og velg ",(0,r.jsx)(n.em,{children:"INTEGRASJONER"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Trykk p\xe5 ",(0,r.jsx)(n.em,{children:"+Ny integrasjon"}),". Pass p\xe5 at det st\xe5r ",(0,r.jsx)(n.em,{children:"PRODUKSJON"})," eller ",(0,r.jsx)(n.em,{children:"VER2"}),"(for ",(0,r.jsx)(n.strong,{children:"testmilj\xf8et"})," til maskinporten) i\nknappen ved siden av:\n",(0,r.jsx)(n.a,{target:"_blank",href:t(7066).Z+"",children:(0,r.jsx)(n.img,{alt:"Administrer  integrasjoner",src:t(5080).Z+"",width:"3008",height:"2232"})})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Fyll ut skjemaet:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Difi-tjeneste"}),": Maskinporten"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Scopes"}),": De du trenger. Ta eventuelt kontakt med leverand\xf8rene av API-et for \xe5 vite hvilke scopes de krever."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Navn p\xe5 integrasjonen"}),": V\xe5rt eksempel: ",(0,r.jsx)(n.code,{children:"uio-gravitee-(prod|test)"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Tillatte grant types"}),": ",(0,r.jsx)(n.code,{children:"urn:ietf:params:oauth:grant-type:jwt-bearer"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Klientautentiseringsmetode"}),": ",(0,r.jsx)(n.code,{children:"private_key_jwt"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Applikasjonstype"}),": web"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Authorization levetid (sekunder)"}),": 0"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Access token levetid (sekunder)"}),": 0"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Refresh token levetid (sekunder)"}),": 0"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Refresh token type"}),": Engangs"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{target:"_blank",href:t(4389).Z+"",children:(0,r.jsx)(n.img,{alt:"Lag en ny  integrasjon",src:t(3265).Z+"",width:"3008",height:"3012"})})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Last opp JWT-n\xf8kkel\nVelg integrasjonen du nettopp laget og velg ",(0,r.jsx)(n.em,{children:"Egne public n\xf8kler"}),". I dialog-vinduet kopierer du inn output fra kommandoen i steg 3 i ",(0,r.jsx)(n.a,{href:"#Lokale-forberedelser",children:"Lokale forberedelser"}),", men med hakeparentes rundt innholdet. Et eksempel:"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'[{"alg": "RS256", "e": "AQAB", "n": "XXXXXXXXXXXXXX...XXXXXXXXXXXXX", "kid": "uio-gravitee-test", "kty": "RSA", "use": "sig"}]\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{target:"_blank",href:t(9489).Z+"",children:(0,r.jsx)(n.img,{alt:"Last opp n\xf8kkel",src:t(1973).Z+"",width:"3108",height:"5130"})})}),"\n",(0,r.jsx)(n.h3,{id:"4-konfigurasjons-steg-i-gravitee",children:"4 Konfigurasjons steg i Gravitee"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{target:"_blank",href:t(9062).Z+"",children:"Last ned template for API-definisjonen for maskinporten."})," og last den opp i graviteee. Se ",(0,r.jsx)(n.a,{href:"/docs/datadeling/veiledere/api-manager/importer-api",children:"veileder for \xe5 registrere en tjeneste i API manager via fil"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Om dette er mot ",(0,r.jsx)(n.strong,{children:"produksjonsystem"})," i stedet for ",(0,r.jsx)(n.strong,{children:"test"}),", naviger til proxy og endpoint (under backend services) . Klikk p\xe5 tannhjulet for PROD, fjern haken for backup endpoint. Slett TEST eller huk av for at test skal v\xe6re backup endpint. ",(0,r.jsx)(n.strong,{children:"Husk \xe5 lagre"})]}),"\n",(0,r.jsxs)(n.li,{children:['G\xe5 p\xe5 design. Klikk p\xe5 policy "Generate JWT" Fyll inn:',"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["_",(0,r.jsx)(n.em,{children:"Key ID"}),": det samme parameteren man satte som ",(0,r.jsx)(n.code,{children:"--kid"})," i steg 3 i ",(0,r.jsx)(n.a,{href:"#Lokale-forberedelser",children:"Lokale forberedelser"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"audiences"}),": Settes til",(0,r.jsx)(n.code,{children:"https://maskinporten.no/"}),"hvis det er ",(0,r.jsx)(n.strong,{children:"produksjon"})," eller ",(0,r.jsx)(n.code,{children:"https://ver2.maskinporten.no/"})," hvis det er ",(0,r.jsx)(n.strong,{children:"test"})," milj\xf8et man skal bruke"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Private key"})," Den private n\xf8kkelen laget i steg 1 i ",(0,r.jsx)(n.a,{href:"#Lokale-forberedelser",children:"Lokale forberedelser"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Husk \xe5 lagre"}),"\n",(0,r.jsx)(n.a,{target:"_blank",href:t(1518).Z+"",children:(0,r.jsx)(n.img,{alt:"Konfigurerer generateJWT",src:t(1973).Z+"",width:"3108",height:"5130"})})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["G\xe5 til Portal og details. Klikk p\xe5 ",(0,r.jsx)(n.em,{children:"START THE API"})," og ",(0,r.jsx)(n.em,{children:"PUBLISH THE API"}),". Vi anbefaler at du for dette APIet ikke klikker p\xe5 ",(0,r.jsx)(n.em,{children:"MAKE PUBLIC"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"5-alternative-oppsett",children:"5 Alternative oppsett"}),"\n",(0,r.jsx)(n.p,{children:"Det som er beskrevet over er anbefalt m\xe5te \xe5 sette opp autentisering mot\nMaskinporten. Det finnes noen andre alternativ, men som vi ikke anbefaler:"}),"\n",(0,r.jsx)(n.p,{children:"Den f\xf8rste er \xe5 bruke virksomhetssertifikatet direkte. Virksomhetssertifikatet\nlastes da opp i API manager, slik at det brukes av token-tjenesten. Dette\nanbefales ikke siden virksomhetssertifikatet generelt ikke b\xf8r deles utenfor\negen institusjon."}),"\n",(0,r.jsx)(n.p,{children:"Det andre alternativet er \xe5 sette opp en mikrotjeneste som kj\xf8rer lokalt hos\ninstitusjonen, som h\xe5ndterer tokens n\xe5r API manager gj\xf8r API-kall mot\nMaskinporten. Dette er noe mer komplisert enn anbefalingen, siden det krever at\ndu setter opp og drifter en lokal tjeneste."})]})}function k(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},9062:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/files/maskinporten-api-template-b06a2a481d076f36c690b41b304e242d.json"},7066:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/files/Samarbeidsportalen-administrasjon-av-tjeneste-b71739839db1b431571506288a8d9436.png"},9489:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/files/Samarbeidsportalen-last-opp-nokkel-d93d3d864d457e67fa978eae276f60d0.png"},4389:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/files/Samarbeidsportalen-opprett-tjeneste-233eccc13dc49dad3be869ecd17a4841.png"},1518:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/files/gravitee-generate-jwt-maskinporten-aca6f1669da921f4e82543780a4db9b6.png"},5080:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/Samarbeidsportalen-administrasjon-av-tjeneste-b71739839db1b431571506288a8d9436.png"},1973:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/Samarbeidsportalen-last-opp-nokkel-d93d3d864d457e67fa978eae276f60d0.png"},3265:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/Samarbeidsportalen-opprett-tjeneste-233eccc13dc49dad3be869ecd17a4841.png"},1151:(e,n,t)=>{t.d(n,{Z:()=>l,a:()=>a});var r=t(7294);const s={},i=r.createContext(s);function a(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);