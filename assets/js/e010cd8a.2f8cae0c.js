"use strict";(self.webpackChunkdocs_sikt_no=self.webpackChunkdocs_sikt_no||[]).push([[2861],{7319:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>p,frontMatter:()=>s,metadata:()=>l,toc:()=>d});var r=t(5893),i=t(1151);const s={description:"Hvordan du kan setter opp JWT-autentisering i Gravitee, for eksempel for Maskinporten, uten at hver API-eier trenger f\xe5 tilgang til n\xf8kkelen.",title:"Backend-autentisering med JWTs"},a="Backend-autentisering med JWTs",l={id:"datadeling/veiledere/api-manager/jwt-mot-backend",title:"Backend-autentisering med JWTs",description:"Hvordan du kan setter opp JWT-autentisering i Gravitee, for eksempel for Maskinporten, uten at hver API-eier trenger f\xe5 tilgang til n\xf8kkelen.",source:"@site/docs/datadeling/veiledere/api-manager/jwt-mot-backend.md",sourceDirName:"datadeling/veiledere/api-manager",slug:"/datadeling/veiledere/api-manager/jwt-mot-backend",permalink:"/docs/datadeling/veiledere/api-manager/jwt-mot-backend",draft:!1,unlisted:!1,editUrl:"https://github.com/sikt-no/docs/tree/master/docs/datadeling/veiledere/api-manager/jwt-mot-backend.md",tags:[],version:"current",lastUpdatedAt:1707125580,formattedLastUpdatedAt:"Feb 5, 2024",frontMatter:{description:"Hvordan du kan setter opp JWT-autentisering i Gravitee, for eksempel for Maskinporten, uten at hver API-eier trenger f\xe5 tilgang til n\xf8kkelen.",title:"Backend-autentisering med JWTs"},sidebar:"datadeling",previous:{title:"Importer API-oppsett fra fil",permalink:"/docs/datadeling/veiledere/api-manager/importer-api"},next:{title:"Legge p\xe5 en enkel policy (IP filter)",permalink:"/docs/datadeling/veiledere/api-manager/legge-pa-enkel-policy"}},o={},d=[{value:"Bakgrunn",id:"bakgrunn",level:2},{value:"Lage JWT i Gravitee",id:"lage-jwt-i-gravitee",level:3},{value:"Bruke JWT til autentisering og motta bearer-token",id:"bruke-jwt-til-autentisering-og-motta-bearer-token",level:3},{value:"Legge ved token",id:"legge-ved-token",level:3},{value:"Eksempel: Maskinporten som API",id:"eksempel-maskinporten-som-api",level:3},{value:"Bruk",id:"bruk",level:3},{value:"Bruksanvisning",id:"bruksanvisning",level:3}];function g(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"backend-autentisering-med-jwts",children:"Backend-autentisering med JWTs"}),"\n",(0,r.jsxs)(n.p,{children:["Hvordan du kan skjule JWT-autentisering i Gravitee, for eksempel for Maskinporten, uten at hver API-eier trenger f\xe5 tilgang til n\xf8kkelen. Merk at dette er en generell oppskrift. For oppsett av JWT til Maskinporten spesifikt, se ",(0,r.jsx)(n.a,{href:"https://docs.sikt.no/docs/datadeling/teknisk-plattform/api/maskinporten/#4-konfigurasjons-steg-i-gravitee",children:"her"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"bakgrunn",children:"Bakgrunn"}),"\n",(0,r.jsx)(n.p,{children:"Flere API-er hos andre institusjoner, bl.a. DF\xd8, krever autentisering med maskinporten. Andre API kan kreve autentisering med andre Authorization servers. Som oftest er det best om applikasjonen f\xe5r tilgang og autentiserer direkte mot Authorization serveren, men noen ganger kan det v\xe6re hensiktsmessig \xe5 autentisere API gateway mot API gateway."}),"\n",(0,r.jsx)(n.p,{children:"DF\xd8 har satt opp API-ene sine i maskinporten slik at man er n\xf8dt til \xe5 bruke enten en assymetrisk n\xf8kkel eller et virksomhetssertifikat til autentisering. Med mange integrasjoner og andre applikasjoner som skal ha tilgang til disse API-ene, blir disse hemmelighetene lagret flere steder hvis hver applikasjon skal autentisere selv. For \xe5 begrense antall steder hemmeligheter legges blir denne autentiseringen heller utf\xf8rt i Gravitee."}),"\n",(0,r.jsx)(n.h3,{id:"lage-jwt-i-gravitee",children:"Lage JWT i Gravitee"}),"\n",(0,r.jsx)(n.p,{children:'Velg API\'et du vil legge til autentisering for. G\xe5 til design i venstre sidemeny, og deretter videre til Policies. Bruk policyen "Generate JWT" for \xe5 lage en JWT. Denne kan brukes videre, f.eks. i policyen "Add header" eller "HTTP Callout".'}),"\n",(0,r.jsx)(n.p,{children:"Generate JWT:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{target:"_blank",href:t(6691).Z+"",children:(0,r.jsx)(n.img,{alt:"Generate JWT policyen",src:t(7783).Z+"",width:"2227",height:"1262"})})}),"\n",(0,r.jsx)(n.p,{children:"Det er mange felt som m\xe5 fylles inn, og hvilke som brukes avhenger av hvilken autorisasjons servere som brukes."}),"\n",(0,r.jsx)(n.p,{children:"Disse er verdt \xe5 merke seg:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'Om sertifikatet er lagret p\xe5 filsystemet (ta kontakt med IntArk-drift for dette), velg "The content of the private key is provided by reading a PKCS12/JKS/PEM file from file system" under "Key resolver". Path til riktig mappe skrives inn i "Private key / Secret key / key store path". Hvis ikke, velg "The content of the private key/secret is provided inline" og lim denne inn i "Private key / Secret key / key store path" lenger ned'}),"\n",(0,r.jsx)(n.li,{children:"Passordet til den private n\xf8kkelen blir vist i klartekst. V\xe6r n\xf8ye og begrens hvem som har tilgang til API-et"}),"\n",(0,r.jsx)(n.li,{children:'Om du har lastet opp sertifikatet til Authorization serveren skriv inn ID-en p\xe5 n\xf8kkelen i feltet "kid". Hvis det er virksomhetssertifikat, ikke fyll inn feltet "kid", men velg heller "Add a certificate chain as axn X5C attribute" i feltet "Certificate chain"'}),"\n",(0,r.jsx)(n.li,{children:"Du kan legge p\xe5 s\xe5 mange ekstra Claims som du vil"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"bruke-jwt-til-autentisering-og-motta-bearer-token",children:"Bruke JWT til autentisering og motta bearer-token"}),"\n",(0,r.jsx)(n.p,{children:"Dette gj\xf8res med HTTP Callout. Legg inn URL til autentiserings-endepunktet du skal bruke og evt. headere/parametere. Legg ved JWT-en som akkurat ble laget ved \xe5 bruke Expression Language-notasjon: ${context.attributes['jwt.generated']}."}),"\n",(0,r.jsx)(n.p,{children:"F.eks. for \xe5 bruke mot maskinporten m\xe5 du legge ved f\xf8lgende data: grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&assertion=${context.attributes['jwt.generated']}."}),"\n",(0,r.jsx)(n.h3,{id:"legge-ved-token",children:"Legge ved token"}),"\n",(0,r.jsx)(n.p,{children:'For \xe5 legge p\xe5 bearer-token mottatt med HTTP Callaout-policyer: i "Transform Headers"-policy, klikk p\xe5 plusstegnet under add, fyll inn Authorization som "Name" og som "value": Bearer {#context.attributes[\'token\']}.'}),"\n",(0,r.jsx)(n.h3,{id:"eksempel-maskinporten-som-api",children:"Eksempel: Maskinporten som API"}),"\n",(0,r.jsx)(n.p,{children:"I Gravitee har vi registrert maskinporten (p.t. versjon 2 test-l\xf8sningen) som et API."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"API-et er ikke publisert"}),"\n",(0,r.jsx)(n.li,{children:"Det er sikret med API n\xf8kkel og sperret til IP"}),"\n",(0,r.jsxs)(n.li,{children:["Backend server endpoint er for test: ",(0,r.jsx)(n.a,{href:"https://ver2.maskinporten.no/token",children:"https://ver2.maskinporten.no/token"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Det er satt opp med f\xf8lgende policyer:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"IP Filtering: NRECs ip-adresser er hvitelistet"}),"\n",(0,r.jsx)(n.li,{children:"Cache: Bruker parameteren scope som key, application som scope, og 3599 (sekunder) som maks varighet p\xe5 cachede objekter. Policyen henter svar fra cache kun n\xe5r http-metoden er GET."}),"\n",(0,r.jsx)(n.li,{children:"Generate JWT: Denne genererer JWT-filen som vi bruker for \xe5 autentisere mot maskinporten. iss (issuer) og scope hentes som parametere, resten av feltene er hardkodet"}),"\n",(0,r.jsx)(n.li,{children:"Assign content: Legger p\xe5 requesten ihht. oauth2-standard og med JWT som akkurat er generert som assertion"}),"\n",(0,r.jsx)(n.li,{children:"Transform parameters: Fjerner parameterne iss og scope"}),"\n",(0,r.jsx)(n.li,{children:"Transform headers: Legger til encoding"}),"\n",(0,r.jsx)(n.li,{children:"Override HTTP method: Endrer til POST"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"API-et er ogs\xe5 satt opp med en cache-ressurs."}),"\n",(0,r.jsxs)(n.p,{children:["Applikasjonene er i tillegg registrert i samarbeidsportalen. Forel\xf8pig er det registrert \xe9n applikasjon med fire scope. Applikasjons-ID-en herfra er den som blir brukt som paramteren ",(0,r.jsx)(n.em,{children:"iss"})," (for Issuer). Denne er ogs\xe5 registrert hos DF\xd8."]}),"\n",(0,r.jsx)(n.p,{children:"Virksomhetssertifikatet er opprettet som en secret i openshift-prosjektet og mountet som katalogen /certs p\xe5 b\xe5de API-manager og Gateway-podene. P\xe5 denne m\xe5ten trenger vi kun registrere path til filen i API-et. Det er ikke n\xf8dvendig, men man kan og lime inn base64-encoded virksomhetssertifikat rett inn i policyen."}),"\n",(0,r.jsx)(n.h3,{id:"bruk",children:"Bruk"}),"\n",(0,r.jsx)(n.p,{children:"API-ene som bruker dette for autentisering har to ekstra policyer:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"HTTP Callout: Denne gj\xf8r en callout til maskinporten-API-et som er registrert hos oss med http metode GET og parameter for riktig scope, riktig issuer og headeren X-Gravitee-Api-Key for \xe5 f\xe5 tilgang"}),"\n",(0,r.jsx)(n.li,{children:"Transform headers: Legger p\xe5 headeren Authorization med verdien 'Bearer' og JWT-tokenet som maskinporten returnerer"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"I tillegg er de registrert som applikasjoner i API manager. Disse har og f\xe5tt tilgang til maskinporten-API-et og API-n\xf8kkelen er registrert i HTTP callout-policyen."}),"\n",(0,r.jsx)(n.h3,{id:"bruksanvisning",children:"Bruksanvisning"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"For \xe5 registrere et API med maskinporten-autentisering m\xe5 det registreres som en applikasjon, og s\xf8ke om tilgang til maskinporten-API-et. N\xe5r tilgang er godkjent brukes API-n\xf8kkelen i http callout-policyen"}),"\n",(0,r.jsxs)(n.li,{children:['P\xe5 siden for \xe5 administrere API-et, velg Design i venstre sidemeny og dra policyen "HTTP Callout" til midten. Fyll inn:',"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"scope: request"}),"\n",(0,r.jsx)(n.li,{children:"HTTP Method: GET (Kan ogs\xe5 v\xe6re POST. Da blir det generert nytt token hver gang. Det skaper un\xf8dvendig belastning p\xe5 maskinporten og er tregt, men gj\xf8r feils\xf8king enklere)"}),"\n",(0,r.jsxs)(n.li,{children:["URL: ",(0,r.jsxs)(n.a,{href:"https://gw-XXX.intark.uh-it.no/maskinporten-test/v2?iss=**%3CISSUER%3E**&scope=**%3CSCOPE%3E**",children:["https://gw-XXX.intark.uh-it.no/maskinporten-test/v2?iss=",(0,r.jsx)(n.strong,{children:"<ISSUER>"}),"&scope=",(0,r.jsx)(n.strong,{children:"<SCOPE>"})]})," (issuer finner du i samarbeidsportalen)"]}),"\n",(0,r.jsx)(n.li,{children:"Legg til Header X-Gravitee-Api-Key. Verdien er API-n\xf8kkelen fra forrige punkt"}),"\n",(0,r.jsx)(n.li,{children:"Legg til Context variabel med navn = Token og value = {#jsonPath(#calloutResponse.content, '$.access_token')}"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Dra s\xe5 policyen Transform Header inn i midten. Under Add/update headers, legg til en med navn Authorization og verdi Bearer {#context.attributes['token']}"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\xd8nsker man \xe5 sende med multiple scopes til maskinporten s\xe5 st\xf8ttes dette, men formatet p\xe5 strengen med scopes bestemmes utifra hvordan man sender med scopes til maskinporten APIet."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Sender man scopet med som en del av URI som eksempelet ovenfor gj\xf8r s\xe5 m\xe5 man selv huske p\xe5 \xe5 manuelt urlencode strenger som inneholder scopene i Assign Content for den aktuelle planen s\xe5 de blir sende slik ut:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"dfo:scope1+dfo:scope_nr2+dfo:scope3\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Sender man scopet med som en header s\xe5 skriver man navnene p\xe5 scopene rett ut med mellomrom imellom i Assign Content for riktig plan. Eksempelet over blir n\xe5 da seende slikt ut:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"dfo:scope1 dfo:scope/nr2 dfo:scope3\n"})})]})}function p(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(g,{...e})}):g(e)}},6691:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/files/image-20200928103116-1-02705284548bf65f9a86dce0e4a779f4.png"},7783:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/image-20200928103116-1-02705284548bf65f9a86dce0e4a779f4.png"},1151:(e,n,t)=>{t.d(n,{Z:()=>l,a:()=>a});var r=t(7294);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);