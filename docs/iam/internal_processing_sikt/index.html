<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-iam/internal_processing_sikt" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Internal Processing - Sikt | Sikt teknisk dokumentasjon</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.sikt.no/docs/iam/internal_processing_sikt"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Internal Processing - Sikt | Sikt teknisk dokumentasjon"><meta data-rh="true" name="description" content="G3internalprocessing"><meta data-rh="true" property="og:description" content="G3internalprocessing"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.sikt.no/docs/iam/internal_processing_sikt"><link data-rh="true" rel="alternate" href="https://docs.sikt.no/docs/iam/internal_processing_sikt" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.sikt.no/docs/iam/internal_processing_sikt" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.210d0366.css">
<script src="/assets/js/runtime~main.9b5ee1cd.js" defer="defer"></script>
<script src="/assets/js/main.728f9ab4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/sikt_logo.svg" alt="Sikt logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/sikt_logo_white.svg" alt="Sikt logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">teknisk dokumentasjon</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Internal Processing - Sikt</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="g3_internal_processing">G3_internal_processing<a href="#g3_internal_processing" class="hash-link" aria-label="Direct link to G3_internal_processing" title="Direct link to G3_internal_processing">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="portalldapexpireentitlementsorgchangejs">PortalLdapExpireEntitlementsOrgChange.js<a href="#portalldapexpireentitlementsorgchangejs" class="hash-link" aria-label="Direct link to PortalLdapExpireEntitlementsOrgChange.js" title="Direct link to PortalLdapExpireEntitlementsOrgChange.js">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="description">Description<a href="#description" class="hash-link" aria-label="Direct link to Description" title="Direct link to Description">​</a></h4>
<p>This script evaluates and revokes non-requestable entitlements based on changes in organization and status for users. It processes user records, checks for specific criteria, and revokes entitlements if necessary.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="input-parameters">Input Parameters<a href="#input-parameters" class="hash-link" aria-label="Direct link to Input Parameters" title="Direct link to Input Parameters">​</a></h4>
<ul>
<li><code>uhid</code>: The unique identifier for the user (optional).</li>
<li><code>log_only</code>: Boolean indicating if the script should only log actions without performing them (optional).</li>
<li><code>evaluate_studyright</code>: Boolean indicating if study rights should be evaluated (optional).</li>
<li><code>evaluate_studentassessments</code>: Boolean indicating if student assessments should be evaluated (optional).</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="local-variables">Local Variables<a href="#local-variables" class="hash-link" aria-label="Direct link to Local Variables" title="Direct link to Local Variables">​</a></h4>
<ul>
<li><code>evaluated</code>: Counter for the number of evaluated records.</li>
<li><code>revoked</code>: Counter for the number of revoked entitlements.</li>
<li><code>arrayEntitlementNamesNoRevoke</code>: Array to store entitlements that should not be revoked.</li>
<li><code>sessionPortalLDAP</code>: Connection object for Portal LDAP.</li>
<li><code>sessionPortal</code>: Connection object for Cloud Portal.</li>
<li><code>sessionMV</code>: Connection object for MetaVault (RIDB).</li>
<li><code>cookie</code>: The cookie used for LDAP change tracking.</li>
<li><code>recordChanges</code>: The set of records fetched from Portal LDAP.</li>
<li><code>recordChange</code>: The current record being processed.</li>
<li><code>recordLDAP</code>: Detailed LDAP record of the current user.</li>
<li><code>arrayPortalEntitlementIDs</code>: Array of entitlement IDs from the portal.</li>
<li><code>arrayEntitlementsToRevoke</code>: Array of entitlements to be revoked.</li>
<li><code>arrayCurrentEntitlements</code>: Array of current entitlements for the user.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="workflow">Workflow<a href="#workflow" class="hash-link" aria-label="Direct link to Workflow" title="Direct link to Workflow">​</a></h4>
<ol>
<li>
<p><strong>Initialize Variables</strong></p>
<ul>
<li>Set initial values for counters and other variables.</li>
<li>Adjust <code>evaluate_studyright</code> and <code>evaluate_studentassessments</code> based on input parameters.</li>
</ul>
</li>
<li>
<p><strong>Create Connections</strong></p>
<ul>
<li>Establish connections to Portal LDAP, Cloud Portal, and MetaVault.</li>
<li>Handle connection errors by logging and returning.</li>
</ul>
</li>
<li>
<p><strong>Set Cookie</strong></p>
<ul>
<li>Determine the appropriate cookie based on <code>log_only</code> parameter.</li>
</ul>
</li>
<li>
<p><strong>Query Records</strong></p>
<ul>
<li>Fetch records from Portal LDAP using a change iterator.</li>
</ul>
</li>
<li>
<p><strong>Iterate Over Records</strong></p>
<ul>
<li>For each record, skip if the change type is &#x27;delete&#x27; or &#x27;add&#x27;.</li>
<li>Fetch detailed LDAP record and skip if essential attributes are missing.</li>
<li>Evaluate if the record meets criteria for entitlement revocation based on status, department codes, location codes, study rights, and student assessments.</li>
</ul>
</li>
<li>
<p><strong>Load Entitlements</strong></p>
<ul>
<li>Load entitlements into memory if not already loaded.</li>
<li>Filter entitlements based on their status and requestability.</li>
</ul>
</li>
<li>
<p><strong>Evaluate Criteria</strong></p>
<ul>
<li>Check if the record meets criteria for entitlement revocation based on various conditions.</li>
<li>Log the evaluation process.</li>
</ul>
</li>
<li>
<p><strong>Revoke Entitlements</strong></p>
<ul>
<li>If criteria are met, determine which entitlements to revoke.</li>
<li>Log the entitlements to be revoked.</li>
<li>If <code>log_only</code> is false, perform the revocation using <code>FnBulkRequestEntitlements</code>.</li>
</ul>
</li>
<li>
<p><strong>Return</strong></p>
<ul>
<li>Log the results of the evaluation and revocation process.</li>
<li>Close all established connections.</li>
<li>Return <code>true</code> to indicate successful completion.</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="external-systems-and-communications">External Systems and Communications<a href="#external-systems-and-communications" class="hash-link" aria-label="Direct link to External Systems and Communications" title="Direct link to External Systems and Communications">​</a></h4>
<ul>
<li><strong>Portal LDAP</strong>: Used to fetch user records and update user attributes.</li>
<li><strong>Cloud Portal</strong>: Used to fetch entitlements and perform revocation.</li>
<li><strong>MetaVault (RIDB)</strong>: Used to query user roles and affiliations.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="response-codesoutputs">Response Codes/Outputs<a href="#response-codesoutputs" class="hash-link" aria-label="Direct link to Response Codes/Outputs" title="Direct link to Response Codes/Outputs">​</a></h4>
<ul>
<li>The script logs the number of evaluated and revoked entitlements.</li>
<li>Returns <code>true</code> if the operation was successful.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h4>
<p>This script evaluates and revokes non-requestable entitlements based on changes in organization and status for users. It ensures that entitlements are revoked when specific criteria are met, and logs the process for auditing purposes.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="emaildisablementnotificationsjs">EmailDisablementNotifications.js<a href="#emaildisablementnotificationsjs" class="hash-link" aria-label="Direct link to EmailDisablementNotifications.js" title="Direct link to EmailDisablementNotifications.js">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="description-1">Description<a href="#description-1" class="hash-link" aria-label="Direct link to Description" title="Direct link to Description">​</a></h4>
<p>This script emails users with a notification that their account is going to expire when they are within the expiration/notification window. It handles different user types (employees, students, guests) and sends notifications accordingly.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="input-parameters-1">Input Parameters<a href="#input-parameters-1" class="hash-link" aria-label="Direct link to Input Parameters" title="Direct link to Input Parameters">​</a></h4>
<ul>
<li><code>key_field</code>: Enum: <code>username</code>, <code>uh-username</code>, <code>uhid</code> (optional)</li>
<li><code>key_value</code>: String (optional)</li>
<li><code>log_only</code>: Boolean</li>
<li><code>debug</code>: Boolean (optional)</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="local-variables-1">Local Variables<a href="#local-variables-1" class="hash-link" aria-label="Direct link to Local Variables" title="Direct link to Local Variables">​</a></h4>
<ul>
<li><code>sessionPortalLDAP</code>: Connection object for Portal LDAP.</li>
<li><code>varNow</code>: Current date formatted as <code>yyyyMMdd</code>.</li>
<li><code>currentDate</code>: Current date formatted as <code>yyyy-MM-dd</code>.</li>
<li><code>results</code>: The set of user records fetched from Portal LDAP.</li>
<li><code>isEmployee</code>, <code>isStudent</code>, <code>isGuest</code>: Booleans indicating the user&#x27;s affiliations.</li>
<li><code>employeeEndDate</code>, <code>lastDate</code>, <code>notificationDays</code>: Dates and notification window for the user.</li>
<li><code>selectedUsername</code>, <code>userEmail</code>: Username and email address of the user.</li>
<li><code>dateNow</code>, <code>daysTillEndDate</code>: Current date and days until the user&#x27;s end date.</li>
<li><code>sendNotification</code>: Boolean indicating if a notification should be sent.</li>
<li><code>previousNotifications</code>: Array of previous notifications sent to the user.</li>
<li><code>TemplateValues</code>: Record containing values for the email template.</li>
<li><code>email</code>, <code>sendEmailResult</code>: Email object and result of the email sending operation.</li>
<li><code>managers</code>, <code>manager</code>: Manager&#x27;s LDAP record and email address.</li>
<li><code>saveResults</code>: Result of saving the LDAP record.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-1">Workflow<a href="#workflow-1" class="hash-link" aria-label="Direct link to Workflow" title="Direct link to Workflow">​</a></h4>
<ol>
<li>
<p><strong>Connect to Portal LDAP</strong></p>
<ul>
<li>Establish connection to Portal LDAP.</li>
<li>Handle connection errors by logging and invoking <code>G3_ErrorHandler</code>.</li>
</ul>
</li>
<li>
<p><strong>Initialize Variables</strong></p>
<ul>
<li>Set initial values for date variables.</li>
</ul>
</li>
<li>
<p><strong>Get the Users</strong></p>
<ul>
<li>Fetch user records from Portal LDAP based on <code>key_field</code> and <code>key_value</code>.</li>
<li>If no specific key is provided, fetch records based on end date and term date.</li>
</ul>
</li>
<li>
<p><strong>Iterate Over Users</strong></p>
<ul>
<li>For each user, determine the exit date and affiliation.</li>
<li>Check if the user is a student with an extended end date.</li>
<li>Set the user&#x27;s email address.</li>
<li>Calculate if the end date is within the notification window.</li>
<li>Skip users with an end date of &#x27;9999-12-31&#x27;, users who have expired in the past, users who have not claimed their account, users outside the notification window, and users who have already been notified.</li>
</ul>
</li>
<li>
<p><strong>Send Notification Email</strong></p>
<ul>
<li>Log user information.</li>
<li>Generate and send the notification email to the user.</li>
<li>If applicable, send a notification email to the user&#x27;s manager.</li>
</ul>
</li>
<li>
<p><strong>Update User Record</strong></p>
<ul>
<li>Update the user record to indicate that the separation email has been sent.</li>
<li>Save the updated LDAP record.</li>
</ul>
</li>
<li>
<p><strong>Return</strong></p>
<ul>
<li>Close the Portal LDAP connection.</li>
<li>Return <code>true</code> to indicate successful completion.</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="external-systems-and-communications-1">External Systems and Communications<a href="#external-systems-and-communications-1" class="hash-link" aria-label="Direct link to External Systems and Communications" title="Direct link to External Systems and Communications">​</a></h4>
<ul>
<li><strong>Portal LDAP</strong>: Used to fetch user records and update user attributes.</li>
<li><strong>AWS SES</strong>: Used to send notification emails.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="response-codesoutputs-1">Response Codes/Outputs<a href="#response-codesoutputs-1" class="hash-link" aria-label="Direct link to Response Codes/Outputs" title="Direct link to Response Codes/Outputs">​</a></h4>
<ul>
<li>Return <code>true</code> if the operation was successful.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="summary-1">Summary<a href="#summary-1" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h4>
<p>This script emails users with a notification that their account is going to expire when they are within the expiration/notification window. It handles different user types and sends notifications accordingly, ensuring that users and their managers are informed about the upcoming account expiration.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sendclaimaccountnotificationsjs">SendClaimAccountNotifications.js<a href="#sendclaimaccountnotificationsjs" class="hash-link" aria-label="Direct link to SendClaimAccountNotifications.js" title="Direct link to SendClaimAccountNotifications.js">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="description-2">Description<a href="#description-2" class="hash-link" aria-label="Direct link to Description" title="Direct link to Description">​</a></h4>
<p>This script generates a claim code and sends an email to users requiring account claim. It processes user records from the Portal LDAP, determines the appropriate email address and claim process, generates the claim code, and sends the email notification.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="input-parameters-2">Input Parameters<a href="#input-parameters-2" class="hash-link" aria-label="Direct link to Input Parameters" title="Direct link to Input Parameters">​</a></h4>
<ul>
<li><code>key_field</code>: Enum: <code>username</code>, <code>uh-username</code>, <code>uhid</code> (optional)</li>
<li><code>key_value</code>: String (optional)</li>
<li><code>log_only</code>: Boolean</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="local-variables-2">Local Variables<a href="#local-variables-2" class="hash-link" aria-label="Direct link to Local Variables" title="Direct link to Local Variables">​</a></h4>
<ul>
<li><code>sessionPD</code>: Connection object for Portal LDAP.</li>
<li><code>employeePostponeClaimMailDays</code>: Number of days to postpone claim mail for employees.</li>
<li><code>varNow</code>: Current date formatted as <code>yyyyMMdd</code>.</li>
<li><code>results</code>: The set of records fetched from Portal LDAP.</li>
<li><code>affiliation</code>, <code>isStudent</code>, <code>isEmployee</code>, <code>isFaculty</code>, <code>isSponsored</code>: Variables to determine the user&#x27;s affiliation.</li>
<li><code>startDateDiff</code>: Difference between the start date and current date.</li>
<li><code>arraySystemEntitlements</code>, <code>arrayProvisionedSystems</code>, <code>arrayRequestedEntitlements</code>: Arrays of system entitlements and provisioned systems for the user.</li>
<li><code>isEntitledLdap</code>, <code>isEntitledAd</code>, <code>isProvisionedLdap</code>, <code>isProvisionedAd</code>, <code>hasADAndLDAPRequested</code>: Booleans indicating the user&#x27;s entitlements and provisioning status.</li>
<li><code>emailAddress</code>: The email address to send the claim notification.</li>
<li><code>isFnr</code>, <code>isDnr</code>: Booleans indicating if the user&#x27;s national ID is a Fnr or Dnr.</li>
<li><code>claimProcess</code>: The claim process to use (1 or 2).</li>
<li><code>claimCode</code>: The generated claim code.</li>
<li><code>saveClaimCodeRecord</code>: The record to save the claim code.</li>
<li><code>claimLink</code>: The claim link to include in the email.</li>
<li><code>TemplateValues</code>: Record containing template values for the email.</li>
<li><code>email</code>: The generated email.</li>
<li><code>sendEmailResult</code>: Result of the email sending operation.</li>
<li><code>saveRecordResult</code>: Result of saving the LDAP record.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-2">Workflow<a href="#workflow-2" class="hash-link" aria-label="Direct link to Workflow" title="Direct link to Workflow">​</a></h4>
<ol>
<li><strong>Create Connections</strong></li>
</ol>
<ul>
<li>Establish connection to Portal LDAP.</li>
<li>Handle connection errors by logging and invoking <code>G3_ErrorHandler</code>.</li>
</ul>
<ol start="2">
<li><strong>Get Accounts Requiring Claim Email</strong></li>
</ol>
<ul>
<li>Fetch records from Portal LDAP based on <code>key_field</code> and <code>key_value</code>.</li>
<li>If no specific key is provided, use a filter to fetch records requiring claim email.</li>
</ul>
<ol start="3">
<li><strong>Iterate Over Accounts</strong></li>
</ol>
<ul>
<li>For each record, skip if disabled or if claimFlag/idautoPersonExtBool4 is true.</li>
<li>Determine the user&#x27;s affiliation and start date difference.</li>
<li>Skip records that don&#x27;t apply based on entitlements and provisioning status.</li>
</ul>
<ol start="4">
<li><strong>Determine Email Address</strong></li>
</ol>
<ul>
<li>Use the user&#x27;s home email address if available.</li>
<li>Log an error and skip the record if the home email is missing.</li>
</ul>
<ol start="5">
<li><strong>Determine Claim Process</strong></li>
</ol>
<ul>
<li>Check if the user&#x27;s national ID is a Fnr or Dnr.</li>
<li>Set the claim process to 1 or 2 based on the national ID.</li>
</ul>
<ol start="6">
<li><strong>Generate Claim Code</strong></li>
</ol>
<ul>
<li>Generate a claim code if the claim process is 2.</li>
<li>Save the claim code to the user&#x27;s LDAP record.</li>
</ul>
<ol start="7">
<li><strong>Generate Claim Email</strong></li>
</ol>
<ul>
<li>Generate the claim link based on the claim process.</li>
<li>Create template values for the email.</li>
<li>Generate the email using <code>FnGenerateEmail</code>.</li>
</ul>
<ol start="8">
<li><strong>Send Email Notification</strong></li>
</ol>
<ul>
<li>Send the email using <code>FnSendEmail</code>.</li>
<li>Handle email sending errors by logging and invoking <code>G3_ErrorHandler</code>.</li>
</ul>
<ol start="9">
<li><strong>Mark Account as Claim Email Sent</strong></li>
</ol>
<ul>
<li>Update the user&#x27;s LDAP record to indicate that the claim email has been sent.</li>
<li>Handle errors by logging and invoking <code>G3_ErrorHandler</code>.</li>
</ul>
<ol start="10">
<li><strong>Return</strong></li>
</ol>
<ul>
<li>Close the connection to Portal LDAP.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="external-systems-and-communications-2">External Systems and Communications<a href="#external-systems-and-communications-2" class="hash-link" aria-label="Direct link to External Systems and Communications" title="Direct link to External Systems and Communications">​</a></h4>
<ul>
<li><strong>Portal LDAP</strong>: Used to fetch user records and update user attributes.</li>
<li><strong>Claim API</strong>: Used to send claim email notifications.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="response-codesoutputs-2">Response Codes/Outputs<a href="#response-codesoutputs-2" class="hash-link" aria-label="Direct link to Response Codes/Outputs" title="Direct link to Response Codes/Outputs">​</a></h4>
<ul>
<li>None explicitly mentioned.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="summary-2">Summary<a href="#summary-2" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h4>
<p>This script generates a claim code and sends an email to users requiring account claim. It handles various user affiliations and entitlements, ensuring that the claim process is appropriate and the email notification is sent successfully.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="portalldapassignbusinessengagementrolesjs">PortalLdapAssignBusinessEngagementRoles.js<a href="#portalldapassignbusinessengagementrolesjs" class="hash-link" aria-label="Direct link to PortalLdapAssignBusinessEngagementRoles.js" title="Direct link to PortalLdapAssignBusinessEngagementRoles.js">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="description-3">Description<a href="#description-3" class="hash-link" aria-label="Direct link to Description" title="Direct link to Description">​</a></h4>
<p>This script is designed to assign or remove business and engagement roles for changed Portal LDAP user objects. It processes changes to LDAP records and updates the roles accordingly.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="input-parameters-3">Input Parameters<a href="#input-parameters-3" class="hash-link" aria-label="Direct link to Input Parameters" title="Direct link to Input Parameters">​</a></h4>
<ul>
<li><code>key_field</code>: String (optional)</li>
<li><code>key_value</code>: String (optional)</li>
<li><code>log_only</code>: Boolean (optional)</li>
<li><code>debug</code>: Boolean (optional)</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="local-variables-3">Local Variables<a href="#local-variables-3" class="hash-link" aria-label="Direct link to Local Variables" title="Direct link to Local Variables">​</a></h4>
<ul>
<li><code>actionSetName</code>: The name of the current action set.</li>
<li><code>fileDate</code>: The current date formatted as <code>yyyyMMdd</code>.</li>
<li><code>total</code>, <code>totalSkipped</code>, <code>totalUnchanged</code>, <code>totalAdd</code>, <code>totalAddFail</code>, <code>totalUpdate</code>, <code>totalUpdateFail</code>, <code>totalEnable</code>, <code>totalEnableFail</code>, <code>totalDisable</code>, <code>totalDisableFail</code>: Counters for tracking various operations and their outcomes.</li>
<li><code>sessionPortalLDAP</code>: Connection object for Portal LDAP.</li>
<li><code>sessionPortal</code>: Connection object for Cloud Portal.</li>
<li><code>cookie</code>: The cookie used for LDAP change tracking.</li>
<li><code>recordChanges</code>: The set of records fetched from Portal LDAP.</li>
<li><code>recordChange</code>: The current record being processed.</li>
<li><code>recordLDAP</code>: Detailed LDAP record of the current user.</li>
<li><code>recordPortalEntitlements</code>: Record of Portal entitlements.</li>
<li><code>arrayPortalEntitlements</code>, <code>arrayPortalEntitlementIDs</code>: Arrays of Portal entitlements and their IDs.</li>
<li><code>addOnly</code>, <code>orgOnly</code>: Booleans indicating the type of change.</li>
<li><code>recordRoles</code>: Record of assigned roles.</li>
<li><code>arrayBusinessRoles</code>, <code>arrayEngagementRoles</code>: Arrays of business and engagement roles.</li>
<li><code>recordOriginalVals</code>, <code>recordNewVals</code>: Original and new values of the record.</li>
<li><code>hasChanged</code>: Boolean indicating if the record has changed.</li>
<li><code>arrayEntitlementIDs</code>, <code>arrayEntitlementsToGrant</code>, <code>arrayEntitlementsToRevoke</code>: Arrays of entitlement IDs to grant and revoke.</li>
<li><code>resultEntitlementSubmit</code>: Result of the entitlement submission.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-3">Workflow<a href="#workflow-3" class="hash-link" aria-label="Direct link to Workflow" title="Direct link to Workflow">​</a></h4>
<ol>
<li><strong>Initialize Variables</strong></li>
</ol>
<ul>
<li>Set initial values for counters and other variables.</li>
</ul>
<ol start="2">
<li><strong>Create Connections</strong></li>
</ol>
<ul>
<li>Establish connections to Portal LDAP and Cloud Portal.</li>
<li>Handle connection errors by logging and invoking <code>G3_ErrorHandler</code>.</li>
</ul>
<ol start="3">
<li><strong>Set Cookie</strong></li>
</ol>
<ul>
<li>Determine the appropriate cookie based on <code>log_only</code> parameter.</li>
</ul>
<ol start="4">
<li><strong>Query Records</strong></li>
</ol>
<ul>
<li>Fetch records from Portal LDAP based on <code>key_field</code> and <code>key_value</code>.</li>
<li>If no specific key is provided, use a change iterator to fetch records.</li>
</ul>
<ol start="5">
<li><strong>Iterate Over Records</strong></li>
</ol>
<ul>
<li>For each record, skip if the change type is &quot;delete&quot;.</li>
<li>Fetch detailed LDAP record and skip if essential attributes are missing.</li>
<li>Log processing information.</li>
</ul>
<ol start="6">
<li><strong>Load Portal Entitlements</strong></li>
</ol>
<ul>
<li>If Portal entitlements are not in memory, load them from the Portal API.</li>
<li>Extract and store entitlements based on their classification.</li>
</ul>
<ol start="7">
<li><strong>Evaluate Change Type</strong></li>
</ol>
<ul>
<li>Determine if the change is an addition only or an organizational change.</li>
<li>Log the evaluation results.</li>
</ul>
<ol start="8">
<li><strong>Assign Roles</strong></li>
</ol>
<ul>
<li>Call <code>FnAssignBusinessEngagementRoles</code> to assign business and engagement roles.</li>
<li>Update the LDAP record with the assigned roles.</li>
</ul>
<ol start="9">
<li><strong>Evaluate for Change</strong></li>
</ol>
<ul>
<li>Compare original and new values of the record to detect changes.</li>
<li>Log the evaluation results.</li>
</ul>
<ol start="10">
<li><strong>Save Record</strong></li>
</ol>
<ul>
<li>Save the updated LDAP record.</li>
<li>Log the update process and handle errors.</li>
<li>Evaluate Portal entitlements and submit requests to grant or revoke entitlements.</li>
</ul>
<ol start="11">
<li><strong>Close Connections</strong></li>
</ol>
<ul>
<li>Close all established connections to Portal LDAP and Cloud Portal.</li>
</ul>
<ol start="12">
<li><strong>Log Results</strong></li>
</ol>
<ul>
<li>Log the results of the synchronization process, including totals for each operation and failures.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="external-systems-and-communications-3">External Systems and Communications<a href="#external-systems-and-communications-3" class="hash-link" aria-label="Direct link to External Systems and Communications" title="Direct link to External Systems and Communications">​</a></h4>
<ul>
<li><strong>Portal LDAP</strong>: Used to fetch user records and update user attributes.</li>
<li><strong>Cloud Portal</strong>: Used to fetch entitlements and submit requests.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="response-codesoutputs-3">Response Codes/Outputs<a href="#response-codesoutputs-3" class="hash-link" aria-label="Direct link to Response Codes/Outputs" title="Direct link to Response Codes/Outputs">​</a></h4>
<ul>
<li>None explicitly mentioned.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="summary-3">Summary<a href="#summary-3" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h4>
<p>This script assigns or removes business and engagement roles for changed Portal LDAP user objects. It handles various operations such as querying records, evaluating changes, assigning roles, and updating LDAP records. The script ensures data consistency and logs detailed results of the synchronization process.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pddeleteaccountsjs">PDDeleteAccounts.js<a href="#pddeleteaccountsjs" class="hash-link" aria-label="Direct link to PDDeleteAccounts.js" title="Direct link to PDDeleteAccounts.js">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="description-4">Description<a href="#description-4" class="hash-link" aria-label="Direct link to Description" title="Direct link to Description">​</a></h4>
<p>This script processes PortalDirectory accounts and deletes any that meet the specified deletion criteria. It handles deprovisioning from various systems before deleting the account from the PortalDirectory.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="input-parameters-4">Input Parameters<a href="#input-parameters-4" class="hash-link" aria-label="Direct link to Input Parameters" title="Direct link to Input Parameters">​</a></h4>
<ul>
<li><code>logOnly</code>: Boolean indicating if the script should only log actions without performing deletions.</li>
<li><code>key_field</code>: String specifying the LDAP field to filter records (optional).</li>
<li><code>key_value</code>: String specifying the value for the <code>key_field</code> to filter records (optional).</li>
<li><code>debug</code>: Boolean indicating if debug information should be logged (optional).</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="local-variables-4">Local Variables<a href="#local-variables-4" class="hash-link" aria-label="Direct link to Local Variables" title="Direct link to Local Variables">​</a></h4>
<ul>
<li><code>sessionPD</code>: Connection object for Portal LDAP.</li>
<li><code>sessionAD</code>: Connection object for Active Directory.</li>
<li><code>process_id</code>: The name of the current process job.</li>
<li><code>accountsDeleted</code>: Counter for the number of accounts deleted.</li>
<li><code>dateNow</code>, <code>currentDate</code>: Current date formatted as <code>yyyyMMdd</code> and <code>yyyy-MM-dd</code> respectively.</li>
<li><code>outFileName</code>, <code>outFile</code>: Name and object for the output file logging deleted accounts.</li>
<li><code>results</code>: The set of records fetched from Portal LDAP.</li>
<li><code>okToDelete</code>, <code>deprovisionFailed</code>: Booleans indicating if the account is okay to delete and if deprovisioning failed.</li>
<li><code>selectedUsername</code>: The username selected for the user.</li>
<li><code>affiliations</code>, <code>isEmployee</code>, <code>isSeparatedEmployee</code>, <code>isStudent</code>, <code>isSeparatedStudent</code>, <code>isDeceased</code>, <code>isGuest</code>, <code>isLongTermGuest</code>, <code>isOverridden</code>: Variables indicating the user&#x27;s affiliations and statuses.</li>
<li><code>allAccessTermDate</code>, <code>deleteDate</code>, <code>deleteDateDiff</code>: Dates and differences used to determine if the account should be deleted.</li>
<li><code>arrayProvisionedSystems</code>, <code>arrayAccounts</code>, <code>arrayAccountsDeprovisioned</code>: Arrays for tracking provisioned systems and deprovisioned accounts.</li>
<li><code>preferredEmail</code>: The preferred email address for the user.</li>
<li><code>isExternalSensor</code>: Boolean indicating if the user is an external sensor.</li>
<li><code>adRecords</code>, <code>adRecord</code>, <code>adDeleteHomeDir</code>, <code>adDeleteRecord</code>: Variables for handling AD records and deletions.</li>
<li><code>deleteResults</code>, <code>mvDeleteResults</code>, <code>recordUpdate</code>, <code>resultUpdateLDAP</code>: Variables for handling LDAP record updates and deletions.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-4">Workflow<a href="#workflow-4" class="hash-link" aria-label="Direct link to Workflow" title="Direct link to Workflow">​</a></h4>
<ol>
<li><strong>Create Connections</strong></li>
</ol>
<ul>
<li>Establish connections to Portal LDAP and Active Directory.</li>
<li>Handle connection errors by logging and invoking <code>G3_ErrorHandler</code>.</li>
</ul>
<ol start="2">
<li><strong>Initialize Variables</strong></li>
</ol>
<ul>
<li>Set initial values for counters and other variables.</li>
<li>Determine the process job name and set the output file name.</li>
</ul>
<ol start="3">
<li><strong>Fetch Inactive Accounts</strong></li>
</ol>
<ul>
<li>Query Portal LDAP for inactive accounts based on <code>key_field</code> and <code>key_value</code> or default criteria.</li>
<li>Handle cases where no records are found.</li>
</ul>
<ol start="4">
<li><strong>Iterate Over Records</strong></li>
</ol>
<ul>
<li>For each record, log the result and reset variables.</li>
<li>Skip users provisioned to <code>ldap</code> or <code>fs fagperson</code>.</li>
<li>Determine user affiliations and statuses.</li>
<li>Calculate deletion dates and determine if the account should be deleted.</li>
</ul>
<ol start="5">
<li><strong>Deprovision Accounts</strong></li>
</ol>
<ul>
<li>Deprovision accounts from various systems (e.g., Inspera, Active Directory).</li>
<li>Handle deprovisioning failures and log actions.</li>
</ul>
<ol start="6">
<li><strong>Delete Portal Directory Account</strong></li>
</ol>
<ul>
<li>Ensure other deprovisioning jobs have completed before deleting the Portal Directory account.</li>
<li>Handle deprovisioning failures and log actions.</li>
<li>Delete the Portal Directory account and log the deletion.</li>
</ul>
<ol start="7">
<li><strong>Update Portal Directory Account</strong></li>
</ol>
<ul>
<li>If deprovisioning failed, update the Portal Directory account to remove deprovisioned systems from <code>idautoPersonAppRoles5</code>.</li>
</ul>
<ol start="8">
<li><strong>Return</strong></li>
</ol>
<ul>
<li>Log the number of accounts deleted and close connections.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="external-systems-and-communications-4">External Systems and Communications<a href="#external-systems-and-communications-4" class="hash-link" aria-label="Direct link to External Systems and Communications" title="Direct link to External Systems and Communications">​</a></h4>
<ul>
<li><strong>Portal LDAP</strong>: Used to fetch and delete user records.</li>
<li><strong>Active Directory</strong>: Used to delete user accounts and home directories.</li>
<li><strong>Inspera</strong>: Used to delete user accounts.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="response-codesoutputs-4">Response Codes/Outputs<a href="#response-codesoutputs-4" class="hash-link" aria-label="Direct link to Response Codes/Outputs" title="Direct link to Response Codes/Outputs">​</a></h4>
<ul>
<li>The script logs the number of accounts deleted and any errors encountered.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="summary-4">Summary<a href="#summary-4" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h4>
<p>This script processes PortalDirectory accounts, deprovisioning them from various systems before deleting the account from the PortalDirectory. It handles different user affiliations and statuses, ensuring that only accounts meeting the deletion criteria are removed.</p>
<hr></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/sikt-no/docs/tree/master/docs/iam/internal_processing_sikt.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-04-25T11:02:18.000Z" itemprop="dateModified">Apr 25, 2025</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#g3_internal_processing" class="table-of-contents__link toc-highlight">G3_internal_processing</a><ul><li><a href="#portalldapexpireentitlementsorgchangejs" class="table-of-contents__link toc-highlight">PortalLdapExpireEntitlementsOrgChange.js</a></li><li><a href="#emaildisablementnotificationsjs" class="table-of-contents__link toc-highlight">EmailDisablementNotifications.js</a></li><li><a href="#sendclaimaccountnotificationsjs" class="table-of-contents__link toc-highlight">SendClaimAccountNotifications.js</a></li><li><a href="#portalldapassignbusinessengagementrolesjs" class="table-of-contents__link toc-highlight">PortalLdapAssignBusinessEngagementRoles.js</a></li><li><a href="#pddeleteaccountsjs" class="table-of-contents__link toc-highlight">PDDeleteAccounts.js</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Sikt Docs</div><ul class="footer__items clean-list"><li class="footer__item"><p>Teknisk dokumentasjon på fellesløsningene Sikt leverer for utdanning og forskning.</p></li></ul></div><div class="col footer__col"><div class="footer__title">Hvordan bidra?</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/sikt-no/docs#editing-the-site-directly-from-the-web-browser" target="_blank" rel="noopener noreferrer" class="footer__link-item">Endre innholdet fra nettleseren</a></li><li class="footer__item"><a href="https://github.com/sikt-no/docs#editing-the-site-locally" target="_blank" rel="noopener noreferrer" class="footer__link-item">Endre innholdet lokalt</a></li><li class="footer__item"><a href="https://github.com/sikt-no/docs/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Opprette en issue i GitHub</a></li></ul></div><div class="col footer__col"><div class="footer__title">Kontaktinformasjon</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://sikt.no/kontakt-oss" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kontakt oss</a></li><li class="footer__item"><a href="https://sikt.no/om-sikt" target="_blank" rel="noopener noreferrer" class="footer__link-item">Om Sikt</a></li><li class="footer__item"><a href="https://sikt.no/personvernerklaering" target="_blank" rel="noopener noreferrer" class="footer__link-item">Personvernerklæring</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/sikt_logo_white.svg" alt="Sikt Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE" width="104" height="28"><img src="/img/sikt_logo_white.svg" alt="Sikt Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU" width="104" height="28"></div><div class="footer__copyright">Copyright © 2025 Sikt – Kunnskapssektorens tjenesteleverandør</div></div></div></footer></div>
</body>
</html>